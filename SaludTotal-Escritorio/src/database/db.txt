CREATE DATABASE SaludTotalBaseDatos;
USE SaludTotalBaseDatos;

CREATE TABLE Rol (
  id_rol INT PRIMARY KEY AUTO_INCREMENT,
  nombreRol ENUM('admin', 'profesional', 'paciente', 'secretaria')
);

CREATE TABLE Paciente (
    id_paciente INT AUTO_INCREMENT PRIMARY KEY,
    nombre_completo VARCHAR(100) NOT NULL,
    dni VARCHAR(8) UNIQUE NOT NULL,
    sexo ENUM('M', 'F') NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    rol_id INT NOT NULL DEFAULT 3, -- Asumiendo que 'paciente' tiene id_rol=3
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	estado INT DEFAULT 1, -- 1: activo, 0: inactivo
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (rol_id) REFERENCES Rol(id_rol)
);

CREATE TABLE Especialidad (
    id_especialidad INT AUTO_INCREMENT PRIMARY KEY,
    nombreEspecialidad VARCHAR(100) NOT NULL UNIQUE,
	estado INT DEFAULT 1 -- 1: Activo, 0: Inactivo
);

CREATE TABLE Profesional (
    id_profesional INT AUTO_INCREMENT PRIMARY KEY,
    nombre_completo VARCHAR(100) NOT NULL,
	  dni VARCHAR(8) UNIQUE NOT NULL,
    sexo ENUM('M', 'F') NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    estado INT DEFAULT 1, -- 1: activo
    especialidad_id INT NOT NULL,
    rol_id INT NOT NULL DEFAULT 2, -- Asumiendo que 'profesional' tiene id_rol=2
	  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (especialidad_id) REFERENCES Especialidad(id_especialidad) ON DELETE CASCADE,
	  FOREIGN KEY (rol_id) REFERENCES Rol(id_rol)
);

CREATE TABLE ProfesionalEspecialidad (
    id INT PRIMARY KEY AUTO_INCREMENT,
    profesional_id INT NOT NULL,
    especialidad_id INT NOT NULL,
    FOREIGN KEY (profesional_id) REFERENCES Profesional(id_profesional) ON DELETE CASCADE,
    FOREIGN KEY (especialidad_id) REFERENCES Especialidad(id_especialidad) ON DELETE CASCADE
);

CREATE TABLE Turno (
    id_turno INT AUTO_INCREMENT PRIMARY KEY,
    paciente_id INT NOT NULL,
    profesional_id INT NOT NULL,
    especialidad_id INT NOT NULL,
    FechaTurno DATE NOT NULL,
    HoraTurno TIME NOT NULL,
    estado ENUM('En espera', 'Confirmado', 'Cancelado', 'Atendido') DEFAULT 'En espera',
    FOREIGN KEY (paciente_id) REFERENCES Paciente(id_paciente),
    FOREIGN KEY (profesional_id) REFERENCES Profesional(id_profesional),
    FOREIGN KEY (especialidad_id) REFERENCES Especialidad(id_especialidad)
);

CREATE TABLE HorariosDisponibles (
    id_horario INT AUTO_INCREMENT PRIMARY KEY,
    profesional_id INT NOT NULL,
    especialidad_id INT NOT NULL,
    DiaSemana ENUM('Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado') NOT NULL,
    HoraInicio TIME NOT NULL,
    HoraFin TIME NOT NULL,
    FOREIGN KEY (profesional_id) REFERENCES Profesional(id_profesional),
    FOREIGN KEY (especialidad_id) REFERENCES Especialidad(id_especialidad)
);

CREATE TABLE HistorialTurnos (
  id_historial INT PRIMARY KEY AUTO_INCREMENT,
  turno_id INT NOT NULL,
  paciente_id INT NOT NULL,
  estado_nuevo ENUM('Confirmado', 'Cancelado', 'Reprogramado', 'Rechazado', 'En espera', 'Atendido') NOT NULL,
  fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (turno_id) REFERENCES Turno(id_turno),
  FOREIGN KEY (paciente_id) REFERENCES Paciente(id_paciente)
);

CREATE TABLE Contacto (
  id_contacto INT PRIMARY KEY AUTO_INCREMENT,
  paciente_id INT,
  email VARCHAR(100) NOT NULL,
  motivo ENUM('Sugerencia', 'Problema tecnico', 'Queja o Reclamo', 'Otro') NOT NULL,
  mensaje TEXT NOT NULL,
  fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (paciente_id) REFERENCES Paciente(id_paciente),
  respondido BOOLEAN DEFAULT FALSE
);

INSERT INTO Rol (id_rol, nombreRol) VALUES (1, 'admin'), (2, 'profesional'), (3, 'paciente');

INSERT INTO Especialidad (nombreEspecialidad) VALUES 
('Clínica General'),
('Pediatría'),
('Cardiología'),
('Ginecología'),
('Sin Especialidad');

INSERT INTO Profesional (nombre_completo, dni, sexo, email, password, rol_id, especialidad_id) VALUES  
('Dr. Carlos Diaz', '12345465', 'M', 'carlos.diaz@saludtotal.com', '1234', 2, 3),  
('Dr. Lisandro López', '12345462', 'M', 'lisandro.lopez@saludtotal.com', '1234', 2, 1),  
('Dr. Pablo Perez', '12345412', 'M', 'pablo.perez@saludtotal.com', '1234', 2, 2),  
('Admin Marisa Torales', '12345460', 'F', 'mt@St.com', '1234', 1, 5);


INSERT INTO ProfesionalEspecialidad (profesional_id, especialidad_id) VALUES 
(1, 1), 
(4, 4),  -- Juan Pérez (Clínica General y Ginecología)
(2, 2),
(3, 3);  -- Ana López (Pediatría y Cardiología)

INSERT INTO HorariosDisponibles (profesional_id, especialidad_id, DiaSemana, HoraInicio, HoraFin) VALUES  
(1, 1, 'Lunes', '09:00:00', '12:00:00'),  
(1, 1, 'Miércoles', '14:00:00', '18:00:00'),  
(2, 2, 'Martes', '08:00:00', '12:00:00'),  
(2, 2, 'Jueves', '16:00:00', '20:00:00'),  
(3, 3, 'Jueves', '10:00:00', '15:00:00'),  
(3, 3, 'Lunes', '15:00:00', '21:00:00'),  
(4, 4, 'Viernes', '09:30:00', '13:30:00'), 
(4, 4, 'Martes', '15:30:00', '21:30:00');

-- Turno
CREATE INDEX idx_turno_profesional ON Turno(profesional_id);
CREATE INDEX idx_turno_paciente ON Turno(paciente_id);
CREATE INDEX idx_turno_estado ON Turno(estado);
CREATE INDEX idx_turno_fecha ON Turno(FechaTurno);

-- Paciente y Profesional
CREATE INDEX idx_paciente_email ON Paciente(email);

-- HistorialTurnos
CREATE INDEX idx_historial_paciente ON HistorialTurnos(paciente_id);
CREATE INDEX idx_historial_turno ON HistorialTurnos(turno_id);

-- HorarioDisponible
CREATE INDEX idx_horario_profesional ON HorariosDisponibles(profesional_id);

INSERT INTO Profesional (nombre_completo, dni, sexo, email, password, rol_id, especialidad_id)
VALUES ('Admin Test', '11223344', 'M', 'admin@saludtotal.com', '1234', 1, 5);

INSERT INTO Rol (id_rol, nombreRol) VALUES (4, 'secretaria');

INSERT INTO Profesional (nombre_completo, dni, sexo, email, password, rol_id, especialidad_id)
VALUES ('Secretaria Test', '11223345', 'M', 'secretaria@saludtotal.com', '1234', 4, 5);

INSERT INTO Paciente (nombre_completo, dni, sexo, email, password, rol_id)
VALUES 
('Juan Pérez', '12345678', 'M', 'juan.perez@example.com', '1234', 3),
('María Gómez', '23456789', 'F', 'maria.gomez@example.com', '1234', 3),
('Carlos López', '34567890', 'M', 'carlos.lopez@example.com', '1234', 3),
('Lucía Fernández', '45678901', 'F', 'lucia.fernandez@example.com', '1234', 3),
('Pedro Ramírez', '56789012', 'M', 'pedro.ramirez@example.com', '1234', 3),
('Ana Martínez', '67890123', 'F', 'ana.martinez@example.com', '1234', 3),
('Sofía Torres', '78901234', 'F', 'sofia.torres@example.com', '1234', 3),
('Martín Silva', '89012345', 'M', 'martin.silva@example.com', '1234', 3),
('Valentina Ruiz', '90123456', 'F', 'valentina.ruiz@example.com', '1234', 3),
('Diego Herrera', '01234567', 'M', 'diego.herrera@example.com', '1234', 3),
('Camila Vega', '11223366', 'F', 'camila.vega@example.com', '1234', 3),
('Tomás Ríos', '22334455', 'M', 'tomas.rios@example.com', '1234', 3),
('Julieta Cabrera', '33445566', 'F', 'julieta.cabrera@example.com', '1234', 3),
('Emilio Duarte', '44556677', 'M', 'emilio.duarte@example.com', '1234', 3),
('Florencia Benítez', '55667788', 'F', 'florencia.benitez@example.com', '1234', 3),
('Nicolás Méndez', '66778899', 'M', 'nicolas.mendez@example.com', '1234', 3);

SELECT 
  p.*,
  GROUP_CONCAT(e.nombreEspecialidad SEPARATOR ', ') AS especialidades,
  r.nombreRol AS rol
FROM Profesional p
LEFT JOIN ProfesionalEspecialidad pe ON p.id_profesional = pe.profesional_id
LEFT JOIN Especialidad e ON pe.especialidad_id = e.id_especialidad
LEFT JOIN Rol r ON p.rol_id = r.id_rol
GROUP BY p.id_profesional
ORDER BY p.nombre_completo ASC;

SELECT 
  p.*,
  e.nombreEspecialidad AS especialidad,
  r.nombreRol AS rol
FROM Profesional p
LEFT JOIN Especialidad e ON p.especialidad_id = e.id_especialidad
LEFT JOIN Rol r ON p.rol_id = r.id_rol
ORDER BY p.nombre_completo ASC;
